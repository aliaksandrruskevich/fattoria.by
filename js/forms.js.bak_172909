if (typeof window.scriptURL === 'undefined') {
  window.scriptURL = "/api/submit-footer.php";
}

const scriptURL = window.scriptURL;

function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validatePhone(phone) {
  // Clean input: remove spaces, dashes, parentheses
  const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
  // International phone number regex (E.164 format)
  const phoneRegex = /^\+?[1-9]\d{1,14}$/;
  return phoneRegex.test(cleanPhone);
}

function showFieldError(field, message) {
  clearFieldError(field);
  field.classList.add('is-invalid');
  const errorDiv = document.createElement('div');
  errorDiv.className = 'invalid-feedback';
  errorDiv.textContent = message;
  field.parentNode.insertBefore(errorDiv, field.nextSibling);
}

function clearFieldError(field) {
  field.classList.remove('is-invalid');
  const errorDiv = field.parentNode.querySelector('.invalid-feedback');
  if (errorDiv) {
    errorDiv.remove();
  }
}

function validateForm(form) {
  let isValid = true;

  const nameField = form.querySelector('input[placeholder*="–∏–º—è"]') || form.name;
  if (nameField && nameField.value.trim().length < 2) {
    showFieldError(nameField, '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
    isValid = false;
  }

  const phoneField = form.querySelector('input[type="tel"]') || form.phone;
  if (phoneField && !validatePhone(phoneField.value)) {
    showFieldError(phoneField, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
    isValid = false;
  }

  const emailField = form.querySelector('input[type="email"]') || form.email;
  if (emailField && emailField.value && !validateEmail(emailField.value)) {
    showFieldError(emailField, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
    isValid = false;
  }

  if (form.request && form.request.value.trim().length < 5) {
    showFieldError(form.request, '–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤');
    isValid = false;
  }

  const agreeCheckbox = form.querySelector('#agree') || form.querySelector('#agreeBottom') || form.querySelector('#agreeTop') || form.querySelector('#agreeTrust') || form.querySelector('#agreeWelcome') || form.querySelector('input[type="checkbox"][required]');
  if (agreeCheckbox && !agreeCheckbox.checked) {
    showFieldError(agreeCheckbox, '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
    isValid = false;
  }

  return isValid;
}

function showToast(message, type = 'info') {
  const existingToasts = document.querySelectorAll('.toast-notification');
  existingToasts.forEach(toast => toast.remove());

  const toast = document.createElement('div');
  toast.className = `toast-notification toast-${type}`;
  toast.textContent = message;

  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
  `;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '1';
  }, 100);

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 5000);
}

function handleFormSubmission(e) {
  e.preventDefault();

  const form = e.target;

  form.querySelectorAll('.is-invalid').forEach(field => clearFieldError(field));

  if (!validateForm(form)) {
    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ', 'error');
    return;
  }

  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
  submitBtn.disabled = true;

  const nameField = form.querySelector('input[placeholder*="–∏–º—è"]') || form.name;
  const phoneField = form.querySelector('input[type="tel"]') || form.phone;
  const emailField = form.querySelector('input[type="email"]') || form.email;

  const formData = new FormData();
  formData.append('name', nameField ? nameField.value.trim() : '');
  formData.append('phone', phoneField ? phoneField.value.trim() : '');

  if (emailField && emailField.value) formData.append('email', emailField.value.trim());
  if (form.request && form.request.value) formData.append('request', form.request.value.trim());
  if (form.comments && form.comments.value) formData.append('request', form.comments.value.trim());
  if (form.address && form.address.value) formData.append('address', form.address.value.trim());
  if (form.loanAmount && form.loanAmount.value) formData.append('loanAmount', form.loanAmount.value);
  if (form.type && form.type.value) formData.append('propertyType', form.type.value);
  if (form.area && form.area.value) formData.append('area', form.area.value);
  if (form.budget && form.budget.value) formData.append('budget', form.budget.value);
  if (form.propertyType && form.propertyType.value) formData.append('propertyType', form.propertyType.value);
  if (form.distance && form.distance.value) formData.append('distance', form.distance.value);
  if (form.message && form.message.value) formData.append('message', form.message.value.trim());

  let formType = '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å';
  if (form.id === 'testDriveForm') formType = '–¢–µ—Å—Ç-–¥—Ä–∞–π–≤ —É—Å–ª—É–≥';
  else if (form.id === 'trustCallbackForm') formType = '–û–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ (–ü–æ—á–µ–º—É –¥–æ–≤–µ—Ä—è—é—Ç)';
  else if (form.id === 'contactForm') formType = '–ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å';
  else if (form.id === 'countrysideForm') formType = '–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–≥–æ—Ä–æ–¥–Ω—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å';
  else if (form.id === 'contactForm') formType = '–ó–∞—è–≤–∫–∞ –Ω–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É';
  else if (form.classList.contains('contact-form')) formType = '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ';

  formData.append('type', formType);
  formData.append('dateTime', new Date().toLocaleString());
  formData.append('userAgent', navigator.userAgent);
  formData.append('pageUrl', window.location.href);

  const formDataObj = {
    name: nameField ? nameField.value.trim() : '',
    contact: phoneField ? phoneField.value.trim() : '',
    source: formType,
    email: emailField && emailField.value ? emailField.value.trim() : '',
    request: form.request && form.request.value ? form.request.value.trim() : '',
    comments: form.comments && form.comments.value ? form.comments.value.trim() : '',
    address: form.address && form.address.value ? form.address.value.trim() : '',
    loanAmount: form.loanAmount && form.loanAmount.value ? form.loanAmount.value : '',
    propertyType: form.type && form.type.value ? form.type.value : '',
    area: form.area && form.area.value ? form.area.value : '',
    budget: form.budget && form.budget.value ? form.budget.value : '',
    distance: form.distance && form.distance.value ? form.distance.value : '',
    message: form.message && form.message.value ? form.message.value.trim() : ''
  };

  fetch('/api/submit-all-forms.php', {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(formDataObj)
  })
  .then(response => {
    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showToast('–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.', 'success');
      const form = submitBtn.closest('form');
      if (form) form.reset();
      form.querySelectorAll('.is-invalid').forEach(field => clearFieldError(field));
    } else {
      throw new Error('Server returned success: false');
    }
  })
  .catch(error => {
    console.error('Form submission error:', error);
    showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
  })
  .finally(() => {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  });
}

//document.addEventListener('submit', function(e) {
  const form = e.target;
  const formIds = ['feedbackFormBottom', 'testDriveForm', 'trustCallbackForm', 'countrysideForm', 'calculatorForm', 'mortgageForm', 'qualityForm', 'filterForm', 'newsletterForm', 'contactForm', 'sellerForm', 'buyerForm', 'propertyInterestForm'];
  if (formIds.some(id => form.id === id) || form.classList.contains('contact-form')) {
    e.preventDefault();
    handleFormSubmission(e);
  }
});
// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ—Å—Ç—Ä–æ–µ–∫
//document.addEventListener('submit', function(e) {
  const form = e.target;
  const formIds = ['feedbackFormBottom', 'testDriveForm', 'trustCallbackForm', 'countrysideForm', 'calculatorForm', 'mortgageForm', 'qualityForm', 'filterForm', 'newsletterForm', 'contactForm', 'sellerForm', 'buyerForm', 'propertyInterestForm', 'modalContactForm'];
  
  if (formIds.some(id => form.id === id) || form.classList.contains('contact-form')) {
    e.preventDefault();
    handleFormSubmission(e);
  }
});

// ============================================================================
// –§–ò–ö–° –î–õ–Ø –ö–ù–û–ü–û–ö "–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–Ø"
// ============================================================================

console.log('üîß Fix for consultation buttons loaded');

document.addEventListener('click', function(e) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    if (e.target.classList.contains('open-modal-btn') || 
        (e.target.textContent && e.target.textContent.toLowerCase().includes('–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü'))) {
        
        console.log('üéØ Click on consultation button:', e.target.textContent.trim());
        e.preventDefault();
        e.stopPropagation();
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
        const project = e.target.getAttribute('data-project') || 
                       e.target.closest('.card')?.querySelector('h1, h2, h3, h4, h5')?.textContent || 
                       '–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É
        showQuickConsultForm(project);
    }
});

function showQuickConsultForm(project) {
    const name = prompt('–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ: ' + project + '\n\n–í–∞—à–µ –∏–º—è:');
    if (!name) return;
    
    const phone = prompt('–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω:');
    if (!phone) return;
    
    console.log('üì§ Sending quick consultation:', {name, phone, project});
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API
    fetch('/api/submit-newbuilding.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: name,
            phone: phone,
            project: project,
            form_type: 'newbuilding',
            source: window.location.href,
            message: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é'
        })
    })
    .then(r => r.json())
    .then(result => {
        alert('‚úÖ ' + result.message);
    })
    .catch(err => {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + err);
    });
}

console.log('‚úÖ Consultation buttons fix ready');
